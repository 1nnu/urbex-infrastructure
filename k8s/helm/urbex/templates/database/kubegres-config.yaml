apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ .Values.database.name }}-conf"
  namespace: {{ .Values.application.namespace }}
data:
  primary_init_script.sh: |
    #!/bin/bash
    set -e

    dt=$(date '+%d/%m/%Y %H:%M:%S');
    echo "$dt - Running init script the 1st time Primary PostgreSql container is created...";

    customDatabaseName="{{ .Values.database.env.POSTGRES_DB }}"
    customUserName="{{ .Values.database.env.POSTGRES_USER }}"
    customUserPassword="{{ .Values.database.env.POSTGRES_PASSWORD }}"

    echo "$dt - Using Helm templated values:"
    echo "  POSTGRES_DB=$customDatabaseName"
    echo "  POSTGRES_USER=$customUserName"
    echo "  POSTGRES_PASSWORD=$customUserPassword"

    echo "$dt - Running: psql -v ON_ERROR_STOP=1 --username $POSTGRES_USER --dbname $POSTGRES_DB ...";

    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
    CREATE USER $customUserName WITH PASSWORD '$customUserPassword';
    CREATE DATABASE $customDatabaseName;
    \connect $customDatabaseName;
    GRANT ALL ON SCHEMA public TO $customUserName;
    EOSQL

    echo "$dt - Init script is completed";
